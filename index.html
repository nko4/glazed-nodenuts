<!DOCTYPE html>
<html lang="en">
<head>
  <title></title>
  <style>
    audio {
      -moz-transition: all 1s ease;
      -ms-transition: all 1s ease;

      -o-transition: all 1s ease;
      -webkit-transition: all 1s ease;
      transition: all 1s ease;
      vertical-align: top;
    }

    input {
      border: 1px solid #d9d9d9;
      border-radius: 1px;
      font-size: 2em;
      margin: .2em;
      width: 30%;
    }

    .setup {
      border-bottom-left-radius: 0;
      border-top-left-radius: 0;
      font-size: 102%;
      height: 47px;
      margin-left: -9px;
      margin-top: 8px;
      position: absolute;
    }

    p { padding: 1em; }

    li {
      border-bottom: 1px solid rgb(189, 189, 189);
      border-left: 1px solid rgb(189, 189, 189);
      padding: .5em;
    }
  </style>
  <script>
    document.createElement('article');
    document.createElement('footer');
  </script>

  <!-- scripts used for broadcasting -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/rtc.js"> </script>
</head>

<body>
<article>



<!-- just copy this <section> and next script -->
<section class="experiment">
  <section>
                    <span>
                        Private ?? <a href="" target="_blank" title="Open this link in new tab. Then your room will be private!"><code><strong id="unique-token">#123456789</strong></code></a>
                    </span>

    <input type="text" id="conference-name">
    <button id="setup-new-conference" class="setup">Setup New Conference</button>
  </section>

  <!-- list of all available broadcasting rooms -->
  <table style="width: 100%;" id="rooms-list"></table>

  <!-- local/remote audios container -->
  <div id="audios-container"></div>
</section>

<script>
  // Muaz Khan     - https://github.com/muaz-khan
  // MIT License   - https://www.webrtc-experiment.com/licence/
  // Documentation - https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RTCMultiConnection

  var connection = new RTCMultiConnection();
  connection.session = {
    audio: true
  };

  // https://github.com/muaz-khan/WebRTC-Experiment/tree/master/socketio-over-nodejs
  connection.openSignalingChannel = function(config) {
    //var SIGNALING_SERVER = 'https://www.webrtc-experiment.com:2015/';
    var SIGNALING_SERVER = 'https://localhost:2015/';
    var channel = config.channel || this.channel || location.hash.substr(1);
    var sender = Math.round(Math.random() * 999999999) + 999999999;

    io.connect(SIGNALING_SERVER).emit('new-channel', {
      channel: channel,
      sender: sender
    });

    var socket = io.connect(SIGNALING_SERVER + channel);
    socket.channel = channel;
    socket.on('connect', function() {
      if (config.callback) config.callback(socket);
    });

    socket.send = function(message) {
      socket.emit('message', {
        sender: sender,
        data: message
      });
    };

    socket.on('message', config.onmessage);
  };

  connection.onstream = function(e) {
    audiosContainer.insertBefore(e.mediaElement, audiosContainer.firstChild);
    rotateAudio(e.mediaElement);
  };

  function rotateAudio(mediaElement) {
    mediaElement.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(0deg)';
    setTimeout(function() {
      mediaElement.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(360deg)';
    }, 1000);
  }

  connection.onstreamended = function(e) {
    e.mediaElement.style.opacity = 0;
    rotateAudio(e.mediaElement);
    setTimeout(function() {
      if (e.mediaElement.parentNode) {
        e.mediaElement.parentNode.removeChild(e.mediaElement);
      }
    }, 1000);
  };

  var sessions = { };
  connection.onNewSession = function(session) {
    if (sessions[session.sessionid]) return;
    sessions[session.sessionid] = session;

    var tr = document.createElement('tr');
    tr.innerHTML = '<td><strong>' + session.extra['session-name'] + '</strong> is running a conference!</td>' +
        '<td><button class="join">Join</button></td>';
    roomsList.insertBefore(tr, roomsList.firstChild);

    var joinRoomButton = tr.querySelector('.join');
    joinRoomButton.setAttribute('data-sessionid', session.sessionid);
    joinRoomButton.onclick = function() {
      this.disabled = true;

      var sessionid = this.getAttribute('data-sessionid');
      session = sessions[sessionid];

      if (!session) throw 'No such session exists.';

      connection.join(session);
    };
  };

  var audiosContainer = document.getElementById('audios-container') || document.body;
  var roomsList = document.getElementById('rooms-list');

  document.getElementById('setup-new-conference').onclick = function() {
    this.disabled = true;
    connection.extra = {
      'session-name': document.getElementById('conference-name').value || 'Anonymous'
    };
    connection.open();
  };

  // setup signaling to search existing sessions
  connection.connect();

  (function() {
    var uniqueToken = document.getElementById('unique-token');
    if (uniqueToken)
      if (location.hash.length > 2) uniqueToken.parentNode.parentNode.parentNode.innerHTML = '<h2 style="text-align:center;"><a href="' + location.href + '" target="_blank">Share this link</a></h2>';
      else uniqueToken.innerHTML = uniqueToken.parentNode.parentNode.href = '#' + (Math.random() * new Date().getTime()).toString(36).toUpperCase().replace( /\./g , '-');
  })();
</script>




</body>
</html>